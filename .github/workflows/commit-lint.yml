name: Commit Lint

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  commitlint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ëª¨ë“  ì»¤ë°‹ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      - name: Get commit messages
        id: get-commits
        run: |
          # PRì˜ ëª¨ë“  ì»¤ë°‹ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
          git log --format=%s ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} > commits.txt
          cat commits.txt

      - name: Validate commit messages
        run: |
          echo "ğŸ“ ì»¤ë°‹ ë©”ì‹œì§€ ê²€ì¦ ì‹œì‘..."
          echo ""
          
          # ì»¤ë°‹ ë©”ì‹œì§€ ê·œì¹™
          # ì˜ˆ) feat: íšŒì›ê°€ì… ê¸°ëŠ¥ ì¶”ê°€
          # ì„¸ë¯¸ì½œë¡  í•„ìˆ˜, ë„ì–´ì“°ê¸° í•„ìˆ˜, ì„¤ëª… 1ê¸€ì ì´ìƒ í•„ìˆ˜
          REGEX='^(feat|fix|docs|style|refactor|test|chore|comment|rename|remove|hotfix): .{1,}'
          
          # Merge ì»¤ë°‹ íŒ¨í„´ (ê²€ì¦ ì œì™¸, Gitì´ ìë™ ìƒì„±í•œ Merge ì»¤ë°‹ë§Œ ì œì™¸)
          MERGE_REGEX='^Merge (pull request|branch|remote-tracking branch)'
          
          FAIL=0
          LINE_NUM=0
          
          while IFS= read -r commit_msg; do
            LINE_NUM=$((LINE_NUM + 1))
            echo "[$LINE_NUM] $commit_msg"
            
            # Merge ì»¤ë°‹ì¸ì§€ í™•ì¸
            if [[ "$commit_msg" =~ $MERGE_REGEX ]]; then
              echo "  â­ï¸  Merge ì»¤ë°‹ (ê²€ì¦ ì œì™¸)"
            elif [[ ! "$commit_msg" =~ $REGEX ]]; then
              echo "  âŒ ê·œì¹™ ìœ„ë°˜!"
              FAIL=1
            else
              echo "  âœ… í†µê³¼"
            fi
            echo ""
          done < commits.txt
          
          if [ $FAIL -eq 1 ]; then
            echo "::error::âŒ ì»¤ë°‹ ë©”ì‹œì§€ê°€ ê·œì¹™ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo ""
            echo "ğŸ“Œ ì˜¬ë°”ë¥¸ í˜•ì‹:"
            echo "  type: subject"
            echo ""
            echo "ğŸ“ ì˜ˆì‹œ:"
            echo "  feat: íšŒì›ê°€ì… ê¸°ëŠ¥ ì¶”ê°€"
            echo "  fix: JWT í† í° ë§Œë£Œ ì²˜ë¦¬ ë²„ê·¸ ìˆ˜ì •"
            echo "  docs: README ì—…ë°ì´íŠ¸"
            echo "  refactor: UserService ë¦¬íŒ©í† ë§"
            echo ""
            echo "ğŸ·ï¸ ì‚¬ìš© ê°€ëŠ¥í•œ type (ì†Œë¬¸ì):"
            echo "  feat     : ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€"
            echo "  fix      : ë²„ê·¸ ìˆ˜ì •"
            echo "  docs     : ë¬¸ì„œ ìˆ˜ì •"
            echo "  style    : ì½”ë“œ í¬ë§·íŒ…, ì„¸ë¯¸ì½œë¡  ëˆ„ë½ ë“±"
            echo "  refactor : ì½”ë“œ ë¦¬íŒ©í† ë§"
            echo "  test     : í…ŒìŠ¤íŠ¸ ì½”ë“œ ì¶”ê°€/ìˆ˜ì •"
            echo "  chore    : ë¹Œë“œ, íŒ¨í‚¤ì§€ ê´€ë¦¬, ê¸°íƒ€ ìˆ˜ì •"
            echo "  comment  : ì£¼ì„ ì¶”ê°€ ë° ë³€ê²½"
            echo "  rename   : íŒŒì¼/í´ë”ëª… ìˆ˜ì •"
            echo "  remove   : íŒŒì¼ ì‚­ì œ"
            echo "  hotfix   : ê¸´ê¸‰ ë²„ê·¸ ìˆ˜ì •"
            echo ""
            echo "ğŸ“‹ ê·œì¹™:"
            echo "  - type: ì†Œë¬¸ì"
            echo "  - ì½œë¡ (:) ë’¤ì— ê³µë°± í•„ìˆ˜"
            echo "  - subject 1ê¸€ì ì´ìƒ ì‘ì„± í•„ìˆ˜"
            echo ""
            echo "ğŸ’¡ ì°¸ê³ : Merge ì»¤ë°‹ì€ ìë™ìœ¼ë¡œ ê²€ì¦ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤."
            exit 1
          fi
          
          echo "âœ… ëª¨ë“  ì»¤ë°‹ ë©”ì‹œì§€ê°€ ê·œì¹™ì„ ë§Œì¡±í•©ë‹ˆë‹¤!"